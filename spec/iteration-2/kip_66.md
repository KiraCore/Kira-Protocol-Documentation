# [⏎](README.md#Roadmap) KIP_66
> Nodes Discovery

Nodes Discovery will be an INTERX feature enabling to visualize all nodes publicly exposed and not exposed to the internet and provide information on how they are interconnected with each other to provide clear understanding of the network layout and to spot potential vulnerabilities. To achieve this goal a new endpoint `/node_list` should be created that will return list of all KIRA nodes in the network and all relevant information about them.

In the INTERX configuration (and start arguments) a new `addrbook` property should be created defining location of the `addrbook.json` file which will be used to determine IP addresses that sentry and priv_sentry containers interact with. The `addrbook` property should be able to accept single file as well as multiple, comma separated files.

The `addrbook.json` is a file generated by containers running Tendermint and contains list of peers that those containers interact with.

Example content:

```
{
        "key": "4ccbed9f49199e20156d00b2",
        "addrs": [
                {
                        "addr": {
                                "id": "1661691970e85ef2052c7349b981e52a2e0677e7",
                                "ip": "172.31.23.138",
                                "port": 36656
                        },
                        "src": {
                                "id": "1661691970e85ef2052c7349b981e52a2e0677e7",
                                "ip": "172.31.23.138",
                                "port": 36656
                        },
                        "buckets": [
                                92,
                                133
                        ],
                        "attempts": 7,
                        "bucket_type": 1,
                        "last_attempt": "2021-03-22T19:41:41.326064567Z",
                        "last_success": "0001-01-01T00:00:00Z",
                        "last_ban_time": "0001-01-01T00:00:00Z"
                }, ...
        ]
}
```

Each `ip` address within the `addrbook.json` is potentially a KIRA node. All IP addresses should be extracted from each addrbook json file for processing.

Each unique (they can repeat) `ip` address in the list ready for processing should be dialed by the `INTERX` via the default INTEREX port `11000` to query chain-id and verify genesis file checksum to ensure that KIRA node is connected to the correct (the same) network. If genesis checksum does not match, chain-id does not match or ip address can't be reached within `3 seconds` then IP should be ignored for the purpose of recursive KIRA nodes discovery using `/node_list` endpoint.

Endpoint `/api/status` should be extended with additional fields to contain all essential information's about the KIRA node:

Example of the new `/api/status` query response
```
{
  "interx_info": {
    "pub_key": {
      "type": "tendermint/PubKeySecp256k1",
      "value": "AtE7qevMJy0MzFtmWp0wWgUc3eD8sZEpcJYY+XsA1sZM"
    },
    "kira_addr": <string>, // kira address (can be faucet or other key that INTERX owner might want to advertise as his)
    "genesis_checksum": <string>, // SHA256 hash
    "chain_id": <string>, // chain id of the network
    "version": <string>, // version of the release
    "sentry_node_id": <string> // node id of the sentry node (if present),
    "priv_sentry_node_id": <string> // node id of the priv sentry node (if present),
    "validator_node_id": <string> // node id of the validator node (if present),
    "seed_node_id": <string> // node id of the seed node (if present)
  }
}
```

For each discovered `ip` both the `/api/status` and `/node_list` endpoint should be dialed to receive information in regards to the KIRA node as well as list of other KIRA nodes that currently queried adders is connected to. Results of the `/node_list` should be used to recursively expand the `/node_list`.

Following information should be gathered from each KIRA node as result of `/node_list` query:

```
"last_update": <integer>, // unix date time
"scanning": <bool>, // if discovery is still running or not
"node_list": [ { 
    "id": <string>, // pub_key
    "ip": <string>,
    "kira_addr": <string>,
    "version": <string>,
    "seed": <bool>,
    "validator": <bool>,
    "peers": [ { "id": <string>, "ping": <integer> }, .... ]
 }, { ... }, ... ]
```

First entry in the `/node_list` should always contain information about the localhost. The `ip` of the localhost should be a public IP address if node is not a validator node, otherwise ip should be set to `null` (private). The `peers` property should further only contain list of `id` of nodes that the node is connected to along `ping` as integer in milliseconds defining how long it takes to dial the node. The `seed` property should be set to true if `seed_node_id` is set while `validator` property if `validator_node_id` is known by the INTERX. 

We have to also ensure that results of the `/node_list` are visible immediately, property `scanning` will be used to define  if discovery process was finalized and map of the network is complete.

Each entry in the `/node_list` should have unique `id` (INTERX pub_key). The whole Nodes Discovery process should be a periodically re-occurring task (as it can take many minutes or even hours to call all `ip` addresses). The `last_update` property should contain a date time when the discovery process started. Because not every `ip` can be reached from our host the `/node_list` can be expanded with entries from other nodes.

_NOTE: INTERX should have a configurable property allowing for defining maximum number of entries that will be scanned during each discovery process (Default 100'000)_

